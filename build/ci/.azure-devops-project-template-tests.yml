parameters:
  vmImageWindows: ''
  vmImageLinux: ''

jobs:
- job: Dotnet_Template_Tests
  displayName: 'dotnet new Templates Tests'

  pool:
    vmImage: ${{ parameters.vmImageWindows }}

  dependsOn: Generate_Packages

  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
      artifactName: NugetPackages

  - template: templates/gitversion.yml

  - script: copy $(System.ArtifactsDirectory)\NugetPackages\vslatest\*.nupkg $(Build.SourcesDirectory)\src\PackageCache
    displayName: Copy Artifacts to PackageCache

  - script: dotnet new -i $(System.ArtifactsDirectory)\NugetPackages\vslatest\Uno.ProjectTemplates.Dotnet*.nupkg
    displayName: Install Project Templates

  - powershell: build\run-template-tests.ps1
    displayName: Run Project Templates Tests
    env:
      NUGET_CI_CONFIG: $(Build.SourcesDirectory)\src\nuget.ci.config
      BUILD_SOURCESDIRECTORY: $(BUILD.SOURCESDIRECTORY)

- job: Dotnet_Template_Tests_Net6
  displayName: 'dotnet new net6 Templates Tests'

  pool:
    vmImage: ${{ parameters.vmImageWindows }}

  dependsOn: Generate_Packages

  variables:
    # net6 related
    DotNetVersion: 6.0.100-preview.4.21255.9
    MauiCheck.Version: 0.4.2
    DotNet.Cli.Telemetry.OptOut: true
    MauiCheck.Manifest: https://raw.githubusercontent.com/Redth/dotnet-maui-check/d40ada53aa6a3b94740c86ca55fc27e62bb63d1b/manifests/maui-dev.manifest.json

  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
      artifactName: NugetPackages

  - template: templates/gitversion.yml

  ## Required until .NET 6 installs properly on Windows using UseDotnet
  - powershell: |
      $ProgressPreference = 'SilentlyContinue'
      Invoke-WebRequest -Uri "https://dot.net/v1/dotnet-install.ps1" -OutFile dotnet-install.ps1
      & .\dotnet-install.ps1 -Version $(DotNetVersion) -InstallDir "$env:ProgramFiles\dotnet\" -Verbose
      & dotnet --list-sdks
    displayName: install .NET $(DotNetVersion)
    errorActionPreference: stop

  - powershell: |
      & dotnet tool update --global redth.net.maui.check --version $(MauiCheck.Version) --add-source https://api.nuget.org/v3/index.json
      & maui-check --ci --non-interactive --fix --skip androidsdk --skip xcode --skip vswin --skip vsmac --manifest $(MauiCheck.Manifest)
    displayName: Install .NET 6 Workloads
    errorActionPreference: stop

  - script: copy $(System.ArtifactsDirectory)\NugetPackages\vslatest\*.nupkg $(Build.SourcesDirectory)\src\PackageCache
    displayName: Copy Artifacts to PackageCache

  - script: dotnet new -i $(System.ArtifactsDirectory)\NugetPackages\vslatest\Uno.ProjectTemplates.Dotnet*.nupkg
    displayName: Install Project Templates

  - powershell: build\run-net6-template-tests.ps1
    displayName: Run Project Templates Tests
    env:
      NUGET_CI_CONFIG: $(Build.SourcesDirectory)\src\nuget.ci.net6.config
      BUILD_SOURCESDIRECTORY: $(BUILD.SOURCESDIRECTORY)

- job: Dotnet_Template_Tests_Linux
  displayName: 'dotnet new Templates Tests - Linux'

  pool:
    vmImage: ${{ parameters.vmImageLinux }}

  container: unoplatform/wasm-build:2.3

  dependsOn: Generate_Packages

  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
      artifactName: NugetPackages

  - template: templates/gitversion.yml

  - script: cp $(System.ArtifactsDirectory)/NugetPackages/vslatest/*.nupkg $(Build.SourcesDirectory)/src/PackageCache
    displayName: Copy Artifacts to PackageCache

  - task: UseDotNet@2
    inputs:
      packageType: sdk
      version: 5.0.102

  - script: dotnet new -i $(System.ArtifactsDirectory)/NugetPackages/vslatest/Uno.ProjectTemplates.Dotnet*.nupkg
    displayName: Install Project Templates

  - pwsh: build/run-template-tests-linux.ps1
    displayName: Run Project Templates Tests
    env:
      NUGET_CI_CONFIG: $(Build.SourcesDirectory)/src/nuget.ci.config
